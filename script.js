const MARKET_OPEN_HOUR=8,MARKET_OPEN_MINUTE=30,MARKET_CLOSE_HOUR=15,MARKET_CLOSE_MINUTE=0,CANDLE_INTERVAL_HOURS=4,CST_OFFSET_MINUTES=-360;let countdownInterval,clockInterval;const startInput=document.getElementById("startDate"),endInput=document.getElementById("endDate"),countdownEl=document.getElementById("countdown"),progressBar=document.getElementById("progressBar"),timeLeftText=document.getElementById("timeLeftText"),candlesRemainingEl=document.getElementById("candlesRemaining"),canvas=document.getElementById("marketClock"),ctx=canvas.getContext("2d"),radius=canvas.width/2;function saveToStorage(){localStorage.setItem("marketCountdownStart",startInput.value),localStorage.setItem("marketCountdownEnd",endInput.value)}function loadFromStorage(){let t=localStorage.getItem("marketCountdownStart"),e=localStorage.getItem("marketCountdownEnd");t&&(startInput.value=t),e&&(endInput.value=e)}function clearStorage(){localStorage.removeItem("marketCountdownStart"),localStorage.removeItem("marketCountdownEnd")}function toCSTDate(t){let e=new Date(t.getTime()+6e4*t.getTimezoneOffset());return new Date(e.getTime()+-216e5)}function isWeekend(t){let e=t.getDay();return 0===e||6===e}function calculateMarketSeconds(t,e){if(t>=e)return 0;let n=0,a=new Date(t);for(;a<e;){if(isWeekend(a)){a.setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let r=new Date(a);r.setHours(8,30,0,0);let o=new Date(a);if(o.setHours(15,0,0,0),a<r&&(a=new Date(r)),a>=o){(a=new Date(r)).setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let s=e<o?e:o;n+=(s-a)/1e3,(a=new Date(s))>=o&&((a=new Date(r)).setDate(a.getDate()+1),a.setHours(0,0,0,0))}return n}function calculateCandlesRemaining(t,e){if(t>=e)return 0;let n=0,a=new Date(t);for(;a<e;){if(isWeekend(a)){a.setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let r=new Date(a);r.setHours(8,30,0,0);let o=new Date(a);if(o.setHours(15,0,0,0),a<r&&(a=new Date(r)),a>=o){(a=new Date(r)).setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let s=e<o?e:o;n+=(s-a)/1e3/14400,(a=new Date(s))>=o&&((a=new Date(r)).setDate(a.getDate()+1),a.setHours(0,0,0,0))}return Math.floor(n)}function formatSecondsWithDays(t){let e=Math.floor(t/86400);t%=86400;let n=Math.floor(t/3600),a=Math.floor(t%3600/60),r=Math.floor(t%60);return`${e>0?`${e} day${e>1?"s":""} `:""}${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}function formatSeconds(t){return`${Math.floor(t/3600).toString().padStart(2,"0")}:${Math.floor(t%3600/60).toString().padStart(2,"0")}:${Math.floor(t%60).toString().padStart(2,"0")}`}function drawClock(t){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#444",ctx.arc(radius,radius,radius-20,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#0f9d58",ctx.lineCap="round";let e=-Math.PI/2;ctx.arc(radius,radius,radius-20,e,e+2*Math.PI*t,!1),ctx.stroke()}function isCurrentTimeMarketHours(t){let e=new Date(t);e.setHours(8,30,0,0);let n=new Date(t);return n.setHours(15,0,0,0),t>=e&&t<=n}function startCountdown(t,e){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),saveToStorage();let n=calculateMarketSeconds(t,e);clockInterval=countdownInterval=setInterval(()=>{let a=new Date,r=toCSTDate(a),o=r<t?t:r,s=calculateMarketSeconds(o,e);if(s<=0){clearInterval(countdownInterval),clearInterval(clockInterval),countdownEl.textContent="â° Time's up!",updateProgressBar(100),drawClock(1),timeLeftText.textContent="00:00:00",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: 0";return}countdownEl.textContent=formatSecondsWithDays(s);let l=(n-s)/n;updateProgressBar(100*l);let $=calculateCandlesRemaining(o,e);candlesRemainingEl.textContent=`Estimated 4H Trading Candles Remaining: ${$}`,r>=t&&r<=e&&isCurrentTimeMarketHours(r),drawClock(l),timeLeftText.textContent=formatSeconds(s)},1e3)}function updateProgressBar(t){progressBar.style.width=`${t.toFixed(1)}%`,progressBar.textContent=`${t.toFixed(1)}%`}function resetAll(){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),startInput.value="",endInput.value="",countdownEl.textContent="--:--:--",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: --",updateProgressBar(0),timeLeftText.textContent="--:--:--",ctx.clearRect(0,0,canvas.width,canvas.height),clearStorage()}document.getElementById("startBtn").addEventListener("click",()=>{let t=startInput.value,e=endInput.value;if(!t||!e){alert("Please select both start and end date/time.");return}let n=new Date(t),a=new Date(e),r=toCSTDate(n),o=toCSTDate(a);if(r>=o){alert("End date/time must be after start date/time.");return}startCountdown(r,o)}),document.getElementById("resetBtn").addEventListener("click",resetAll),window.addEventListener("load",()=>{loadFromStorage()});