const themeToggle=document.getElementById("themeToggle"),savedTheme=localStorage.getItem("marketTheme");function updateToggleIcon(){themeToggle.textContent=document.body.classList.contains("day-mode")?"\uD83C\uDF1E":"\uD83C\uDF19"}"day"===savedTheme&&document.body.classList.add("day-mode"),updateToggleIcon(),themeToggle.addEventListener("click",()=>{document.body.classList.toggle("day-mode");let e=document.body.classList.contains("day-mode");localStorage.setItem("marketTheme",e?"day":"night"),updateToggleIcon()});const MARKET_OPEN_HOUR=8,MARKET_OPEN_MINUTE=30,MARKET_CLOSE_HOUR=15,MARKET_CLOSE_MINUTE=0,CANDLE_INTERVAL_HOURS=4,TIMEZONES={EST:-300,CST:-360,MST:-420,PST:-480};let selectedTimezone=localStorage.getItem("marketTimezone")||"CST";const timezoneSelect=document.getElementById("timezoneSelect"),timezoneIcon=document.getElementById("timezoneIcon");function updateTimezoneLabels(){document.querySelector("h2").textContent=`⏳ Market Hours Countdown (${selectedTimezone})`,document.querySelector('label[for="startDate"]').textContent=`Start Date & Time (${selectedTimezone}):`,document.querySelector('label[for="endDate"]').textContent=`End Date & Time (${selectedTimezone}):`}timezoneSelect.value=selectedTimezone,updateTimezoneLabels(),timezoneIcon.addEventListener("click",()=>{timezoneSelect.style.display="block"===timezoneSelect.style.display?"none":"block"}),timezoneSelect.addEventListener("change",()=>{selectedTimezone=timezoneSelect.value,localStorage.setItem("marketTimezone",selectedTimezone),updateTimezoneLabels(),alert(`Timezone set to ${selectedTimezone}. Restart countdown to apply.`)});let countdownInterval,clockInterval;const startInput=document.getElementById("startDate"),endInput=document.getElementById("endDate"),countdownEl=document.getElementById("countdown"),progressBar=document.getElementById("progressBar"),timeLeftText=document.getElementById("timeLeftText"),candlesRemainingEl=document.getElementById("candlesRemaining"),canvas=document.getElementById("marketClock"),ctx=canvas.getContext("2d"),radius=canvas.width/2;function saveToStorage(){localStorage.setItem("marketCountdownStart",startInput.value),localStorage.setItem("marketCountdownEnd",endInput.value)}function loadFromStorage(){let e=localStorage.getItem("marketCountdownStart"),t=localStorage.getItem("marketCountdownEnd");e&&(startInput.value=e),t&&(endInput.value=t)}function clearStorage(){localStorage.removeItem("marketCountdownStart"),localStorage.removeItem("marketCountdownEnd")}function toMarketTZDate(e){let t=TIMEZONES[selectedTimezone],n=new Date(e.getTime()+6e4*e.getTimezoneOffset());return new Date(n.getTime()+6e4*t)}function isWeekend(e){let t=e.getDay();return 0===t||6===t}function calculateMarketSeconds(e,t){if(e>=t)return 0;let n=0,o=new Date(e);for(;o<t;){if(isWeekend(o)){o.setDate(o.getDate()+1),o.setHours(0,0,0,0);continue}let a=new Date(o);a.setHours(8,30,0,0);let r=new Date(o);if(r.setHours(15,0,0,0),o<a&&(o=new Date(a)),o>=r){(o=new Date(a)).setDate(o.getDate()+1),o.setHours(0,0,0,0);continue}let l=t<r?t:r;n+=(l-o)/1e3,(o=new Date(l))>=r&&((o=new Date(a)).setDate(o.getDate()+1),o.setHours(0,0,0,0))}return n}function calculateCandlesRemaining(e,t){if(e>=t)return 0;let n=0,o=new Date(e);for(;o<t;){if(isWeekend(o)){o.setDate(o.getDate()+1),o.setHours(0,0,0,0);continue}let a=new Date(o);a.setHours(8,30,0,0);let r=new Date(o);if(r.setHours(15,0,0,0),o<a&&(o=new Date(a)),o>=r){(o=new Date(a)).setDate(o.getDate()+1),o.setHours(0,0,0,0);continue}let l=t<r?t:r;n+=(l-o)/1e3/14400,(o=new Date(l))>=r&&((o=new Date(a)).setDate(o.getDate()+1),o.setHours(0,0,0,0))}return Math.floor(n)}function formatSecondsWithDays(e){let t=Math.floor(e/86400);e%=86400;let n=Math.floor(e/3600),o=Math.floor(e%3600/60),a=Math.floor(e%60);return`${t>0?`${t} day${t>1?"s":""} `:""}${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}function formatSeconds(e){return`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")}`}function drawClock(e){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#444",ctx.arc(radius,radius,radius-20,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#0f9d58",ctx.lineCap="round";let t=-Math.PI/2;ctx.arc(radius,radius,radius-20,t,t+2*Math.PI*e,!1),ctx.stroke()}function isCurrentTimeMarketHours(e){let t=new Date(e);t.setHours(8,30,0,0);let n=new Date(e);return n.setHours(15,0,0,0),e>=t&&e<=n}function startCountdown(e,t){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),saveToStorage();let n=calculateMarketSeconds(e,t);clockInterval=countdownInterval=setInterval(()=>{let o=new Date,a=toMarketTZDate(o),r=a<e?e:a,l=calculateMarketSeconds(r,t);if(l<=0){clearInterval(countdownInterval),clearInterval(clockInterval),countdownEl.textContent="⏰ Time's up!",updateProgressBar(100),drawClock(1),timeLeftText.textContent="00:00:00",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: 0";return}countdownEl.textContent=formatSecondsWithDays(l);let s=(n-l)/n;updateProgressBar(100*s);let d=calculateCandlesRemaining(r,t);candlesRemainingEl.textContent=`Estimated 4H Trading Candles Remaining: ${d}`,a>=e&&a<=t&&isCurrentTimeMarketHours(a),drawClock(s),timeLeftText.textContent=formatSeconds(l)},1e3)}function updateProgressBar(e){progressBar.style.width=`${e.toFixed(1)}%`,progressBar.textContent=`${e.toFixed(1)}%`}function resetAll(){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),startInput.value="",endInput.value="",countdownEl.textContent="--:--:--",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: --",updateProgressBar(0),timeLeftText.textContent="--:--:--",ctx.clearRect(0,0,canvas.width,canvas.height),clearStorage()}document.getElementById("startBtn").addEventListener("click",()=>{let e=startInput.value,t=endInput.value;if(!e||!t){alert("Please select both start and end date/time.");return}let n=new Date(e),o=new Date(t),a=toMarketTZDate(n),r=toMarketTZDate(o);if(a>=r){alert("End date/time must be after start date/time.");return}startCountdown(a,r)}),document.getElementById("resetBtn").addEventListener("click",resetAll),window.addEventListener("load",()=>{loadFromStorage()});
