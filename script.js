const themeToggle=document.getElementById("themeToggle"),savedTheme=localStorage.getItem("marketTheme");function updateToggleIcon(){themeToggle.textContent=document.body.classList.contains("day-mode")?"\uD83C\uDF1E":"\uD83C\uDF19"}"day"===savedTheme&&document.body.classList.add("day-mode"),updateToggleIcon(),themeToggle.addEventListener("click",()=>{document.body.classList.toggle("day-mode");let e=document.body.classList.contains("day-mode");localStorage.setItem("marketTheme",e?"day":"night"),updateToggleIcon()});const MARKET_OPEN_HOUR=8,MARKET_OPEN_MINUTE=30,MARKET_CLOSE_HOUR=15,MARKET_CLOSE_MINUTE=0,CANDLE_INTERVAL_HOURS=4,TIMEZONES={EST:-300,CST:-360,MST:-420,PST:-480};let selectedTimezone=localStorage.getItem("marketTimezone")||"CST";const timezoneSelect=document.getElementById("timezoneSelect"),timezoneIcon=document.getElementById("timezoneIcon");function updateTimezoneLabels(){document.querySelector("h3").textContent=`⏳ Market Hours Countdown (${selectedTimezone})`,document.querySelector('label[for="startDate"]').textContent=`Start Date & Time (${selectedTimezone}):`,document.querySelector('label[for="endDate"]').textContent=`End Date & Time (${selectedTimezone}):`}timezoneSelect.value=selectedTimezone,updateTimezoneLabels(),timezoneIcon.addEventListener("click",()=>{timezoneSelect.style.display="block"===timezoneSelect.style.display?"none":"block"}),timezoneSelect.addEventListener("change",()=>{selectedTimezone=timezoneSelect.value,localStorage.setItem("marketTimezone",selectedTimezone),updateTimezoneLabels(),alert(`Timezone set to ${selectedTimezone}. Restart countdown to apply.`)});let countdownInterval,clockInterval;const startInput=document.getElementById("startDate"),endInput=document.getElementById("endDate"),countdownEl=document.getElementById("countdown"),progressBar=document.getElementById("progressBar"),timeLeftText=document.getElementById("timeLeftText"),candlesRemainingEl=document.getElementById("candlesRemaining"),canvas=document.getElementById("marketClock"),ctx=canvas.getContext("2d"),radius=canvas.width/2;function saveToStorage(){localStorage.setItem("marketCountdownStart",startInput.value),localStorage.setItem("marketCountdownEnd",endInput.value)}function loadFromStorage(){let e=localStorage.getItem("marketCountdownStart"),t=localStorage.getItem("marketCountdownEnd");e&&(startInput.value=e),t&&(endInput.value=t)}function clearStorage(){localStorage.removeItem("marketCountdownStart"),localStorage.removeItem("marketCountdownEnd")}function toMarketTZDate(e){let t=TIMEZONES[selectedTimezone],n=new Date(e.getTime()+6e4*e.getTimezoneOffset());return new Date(n.getTime()+6e4*t)}function isWeekend(e){let t=e.getDay();return 0===t||6===t}function calculateMarketSeconds(e,t){if(e>=t)return 0;let n=0,a=new Date(e);for(;a<t;){if(isWeekend(a)){a.setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let o=new Date(a);o.setHours(8,30,0,0);let r=new Date(a);if(r.setHours(15,0,0,0),a<o&&(a=new Date(o)),a>=r){(a=new Date(o)).setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let l=t<r?t:r;n+=(l-a)/1e3,(a=new Date(l))>=r&&((a=new Date(o)).setDate(a.getDate()+1),a.setHours(0,0,0,0))}return n}function calculateCandlesRemaining(e,t){if(e>=t)return 0;let n=0,a=new Date(e);for(;a<t;){if(isWeekend(a)){a.setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let o=new Date(a);o.setHours(8,30,0,0);let r=new Date(a);if(r.setHours(15,0,0,0),a<o&&(a=new Date(o)),a>=r){(a=new Date(o)).setDate(a.getDate()+1),a.setHours(0,0,0,0);continue}let l=t<r?t:r;n+=(l-a)/1e3/14400,(a=new Date(l))>=r&&((a=new Date(o)).setDate(a.getDate()+1),a.setHours(0,0,0,0))}return Math.floor(n)}function formatSecondsWithDays(e){let t=Math.floor(e/86400);e%=86400;let n=Math.floor(e/3600),a=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t>0?`${t} day${t>1?"s":""} `:""}${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}function formatSeconds(e){return`${Math.floor(e/3600).toString().padStart(2,"0")}:${Math.floor(e%3600/60).toString().padStart(2,"0")}:${Math.floor(e%60).toString().padStart(2,"0")}`}function drawClock(e){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#444",ctx.arc(radius,radius,radius-20,0,2*Math.PI),ctx.stroke(),ctx.beginPath(),ctx.lineWidth=15,ctx.strokeStyle="#0f9d58",ctx.lineCap="round";let t=-Math.PI/2;ctx.arc(radius,radius,radius-20,t,t+2*Math.PI*e,!1),ctx.stroke()}function isCurrentTimeMarketHours(e){let t=new Date(e);t.setHours(8,30,0,0);let n=new Date(e);return n.setHours(15,0,0,0),e>=t&&e<=n}function startCountdown(e,t){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),saveToStorage();let n=calculateMarketSeconds(e,t);clockInterval=countdownInterval=setInterval(()=>{let a=new Date,o=toMarketTZDate(a),r=o<e?e:o,l=calculateMarketSeconds(r,t);if(l<=0){clearInterval(countdownInterval),clearInterval(clockInterval),countdownEl.textContent="⏰ Time's up!",updateProgressBar(100),drawClock(1),timeLeftText.textContent="00:00:00",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: 0";return}countdownEl.textContent=formatSecondsWithDays(l);let s=(n-l)/n;updateProgressBar(100*s);let i=calculateCandlesRemaining(r,t);candlesRemainingEl.textContent=`Estimated 4H Trading Candles Remaining: ${i}`,o>=e&&o<=t&&isCurrentTimeMarketHours(o),drawClock(s),timeLeftText.textContent=formatSeconds(l)},1e3)}function updateProgressBar(e){progressBar.style.width=`${e.toFixed(1)}%`,progressBar.textContent=`${e.toFixed(1)}%`}function resetAll(){countdownInterval&&clearInterval(countdownInterval),clockInterval&&clearInterval(clockInterval),startInput.value="",endInput.value="",countdownEl.textContent="--:--:--",candlesRemainingEl.textContent="Estimated 4H Trading Candles Remaining: --",updateProgressBar(0),timeLeftText.textContent="--:--:--",ctx.clearRect(0,0,canvas.width,canvas.height),clearStorage()}document.getElementById("startBtn").addEventListener("click",()=>{let e=startInput.value,t=endInput.value;if(!e||!t){alert("Please select both start and end date/time.");return}let n=new Date(e),a=new Date(t),o=toMarketTZDate(n),r=toMarketTZDate(a);if(o>=r){alert("End date/time must be after start date/time.");return}startCountdown(o,r)}),document.getElementById("resetBtn").addEventListener("click",resetAll),window.addEventListener("load",()=>{loadFromStorage()});const toggleBtns=document.querySelectorAll(".toggle-btn"),sections=document.querySelectorAll(".section");toggleBtns.forEach(e=>{e.addEventListener("click",()=>{toggleBtns.forEach(e=>e.classList.remove("active")),sections.forEach(e=>e.classList.remove("active")),e.classList.add("active"),document.getElementById(e.dataset.target).classList.add("active")})});const entryInput=document.getElementById("entryPrice"),exitInput=document.getElementById("exitPrice"),slider=document.getElementById("profitSlider"),percentLabel=document.getElementById("profitPercentLabel"),resultEl=document.getElementById("profitResult");function calculateProfit(){exitInput.dispatchEvent(new Event("input"))}function resetProfit(){entryInput.value="",exitInput.value="",slider.value=0,percentLabel.textContent="0%",resultEl.textContent="--%"}slider.addEventListener("input",()=>{let e=parseFloat(entryInput.value),t=parseFloat(slider.value);if(percentLabel.textContent=t+"%",!e||e<=0){exitInput.value="",resultEl.textContent="--%";return}let n=e*(1+t/100);exitInput.value=n.toFixed(2),resultEl.textContent=t.toFixed(2)+"%"}),exitInput.addEventListener("input",()=>{let e=parseFloat(entryInput.value),t=parseFloat(exitInput.value);if(!e||!t){resultEl.textContent="--%";return}let n=(t-e)/e*100;slider.value=Math.min(Math.max(n,0),1e3),percentLabel.textContent=slider.value+"%",resultEl.textContent=n.toFixed(2)+"%"});let events=JSON.parse(localStorage.getItem("eventsCountdown"))||[];const eventsList=document.getElementById("eventsList");function addEvent(){let e=document.getElementById("eventName").value.trim(),t=document.getElementById("eventDate").value;if(!e||!t){alert("Please enter event name and date/time");return}let n={id:Date.now(),name:e,time:new Date(t).getTime()};events.push(n),saveEvents(),renderEvents(),document.getElementById("eventName").value="",document.getElementById("eventDate").value=""}function removeEvent(e){events=events.filter(t=>t.id!==e),saveEvents(),renderEvents()}function saveEvents(){localStorage.setItem("eventsCountdown",JSON.stringify(events))}function renderEvents(){if(eventsList.innerHTML="",0===events.length){eventsList.innerHTML="<p>No events added.</p>";return}events.sort((e,t)=>e.time-t.time).forEach(e=>{let t=document.createElement("div");t.className="event-card",t.innerHTML=`
                <div class="event-title">
                    ${e.name}
                    <button class="event-remove" onclick="removeEvent(${e.id})" title="Remove Event">\xd7</button>
                </div>
                <div class="event-time" id="event-${e.id}">--:--:--</div>

            `,eventsList.appendChild(t)})}function updateEventCountdowns(){let e=Date.now();events.forEach(t=>{let n=document.getElementById(`event-${t.id}`);if(!n)return;let a=t.time-e;if(a<=0){n.textContent="⏰ Event Started!";return}let o=Math.floor(a/864e5);n.textContent=`${o>0?o+"d ":""}${Math.floor(a%864e5/36e5).toString().padStart(2,"0")}:${Math.floor(a%36e5/6e4).toString().padStart(2,"0")}:${Math.floor(a%6e4/1e3).toString().padStart(2,"0")}`})}setInterval(updateEventCountdowns,1e3),renderEvents();
